{"ast":null,"code":"'use strict';\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) {\n  return typeof obj;\n} : function (obj) {\n  return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj;\n};\n\nvar _createClass = function () {\n  function defineProperties(target, props) {\n    for (var i = 0; i < props.length; i++) {\n      var descriptor = props[i];\n      descriptor.enumerable = descriptor.enumerable || false;\n      descriptor.configurable = true;\n      if (\"value\" in descriptor) descriptor.writable = true;\n      Object.defineProperty(target, descriptor.key, descriptor);\n    }\n  }\n\n  return function (Constructor, protoProps, staticProps) {\n    if (protoProps) defineProperties(Constructor.prototype, protoProps);\n    if (staticProps) defineProperties(Constructor, staticProps);\n    return Constructor;\n  };\n}();\n\nfunction _classCallCheck(instance, Constructor) {\n  if (!(instance instanceof Constructor)) {\n    throw new TypeError(\"Cannot call a class as a function\");\n  }\n}\n\nfunction _possibleConstructorReturn(self, call) {\n  if (!self) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self;\n}\n\nfunction _inherits(subClass, superClass) {\n  if (typeof superClass !== \"function\" && superClass !== null) {\n    throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass);\n  }\n\n  subClass.prototype = Object.create(superClass && superClass.prototype, {\n    constructor: {\n      value: subClass,\n      enumerable: false,\n      writable: true,\n      configurable: true\n    }\n  });\n  if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass;\n}\n\nvar _require = require('@twilio/webrtc/lib/util'),\n    guessBrowser = _require.guessBrowser;\n\nvar _require2 = require('@twilio/webrtc'),\n    MediaStream = _require2.MediaStream;\n\nvar _require3 = require('../../util'),\n    waitForEvent = _require3.waitForEvent,\n    waitForSometime = _require3.waitForSometime;\n\nvar localMediaRestartDeferreds = require('../../util/localmediarestartdeferreds');\n\nvar Track = require('./');\n/**\n * A {@link MediaTrack} represents audio or video that can be sent to or\n * received from a {@link Room}.\n * @extends Track\n * @property {Track.ID} id - This {@link Track}'s ID\n * @property {boolean} isStarted - Whether or not the {@link MediaTrack} has\n *   started\n * @property {boolean} isEnabled - Whether or not the {@link MediaTrack} is\n *   enabled (i.e., whether it is paused or muted)\n * @property {Track.Kind} kind - The kind of the underlying\n *   MediaStreamTrack, \"audio\" or \"video\"\n * @property {MediaStreamTrack} mediaStreamTrack - The underlying\n *   MediaStreamTrack\n * @emits MediaTrack#disabled\n * @emits MediaTrack#enabled\n * @emits MediaTrack#started\n */\n\n\nvar MediaTrack = function (_Track) {\n  _inherits(MediaTrack, _Track);\n  /**\n   * Construct a {@link MediaTrack}.\n   * @param {MediaTrackTransceiver} mediaTrackTransceiver\n   * @param {{log: Log}} options\n   */\n\n\n  function MediaTrack(mediaTrackTransceiver, options) {\n    _classCallCheck(this, MediaTrack);\n\n    options = Object.assign({\n      playPausedElementsIfNotBackgrounded: guessBrowser() === 'safari' && (typeof document === 'undefined' ? 'undefined' : _typeof(document)) === 'object' && typeof document.addEventListener === 'function' && typeof document.visibilityState === 'string'\n    }, options);\n\n    var _this = _possibleConstructorReturn(this, (MediaTrack.__proto__ || Object.getPrototypeOf(MediaTrack)).call(this, mediaTrackTransceiver.id, mediaTrackTransceiver.kind, options));\n\n    var isStarted = false;\n    options = Object.assign({\n      MediaStream: MediaStream\n    }, options);\n    /* istanbul ignore next */\n\n    Object.defineProperties(_this, {\n      _attachments: {\n        value: new Set()\n      },\n      _dummyEl: {\n        value: null,\n        writable: true\n      },\n      _elShims: {\n        value: new WeakMap()\n      },\n      _isStarted: {\n        get: function get() {\n          return isStarted;\n        },\n        set: function set(_isStarted) {\n          isStarted = _isStarted;\n        }\n      },\n      _playPausedElementsIfNotBackgrounded: {\n        value: options.playPausedElementsIfNotBackgrounded\n      },\n      _shouldShimAttachedElements: {\n        value: options.workaroundWebKitBug212780 || options.playPausedElementsIfNotBackgrounded\n      },\n      _MediaStream: {\n        value: options.MediaStream\n      },\n      isStarted: {\n        enumerable: true,\n        get: function get() {\n          return isStarted;\n        }\n      },\n      mediaStreamTrack: {\n        enumerable: true,\n        get: function get() {\n          return mediaTrackTransceiver.track;\n        }\n      }\n    });\n\n    _this._initialize();\n\n    return _this;\n  }\n  /**\n   * @private\n   */\n\n\n  _createClass(MediaTrack, [{\n    key: '_start',\n    value: function _start() {\n      this._log.debug('Started');\n\n      this._isStarted = true;\n\n      if (this._dummyEl) {\n        this._dummyEl.oncanplay = null;\n      } // eslint-disable-next-line no-use-before-define\n\n\n      this.emit('started', this);\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_initialize',\n    value: function _initialize() {\n      var self = this;\n\n      this._log.debug('Initializing');\n\n      this._dummyEl = this._createElement();\n      this.mediaStreamTrack.addEventListener('ended', function onended() {\n        self._end();\n\n        self.mediaStreamTrack.removeEventListener('ended', onended);\n      });\n\n      if (this._dummyEl) {\n        this._dummyEl.muted = true;\n        this._dummyEl.oncanplay = this._start.bind(this, this._dummyEl);\n\n        this._attach(this._dummyEl);\n\n        this._attachments.delete(this._dummyEl);\n      }\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_end',\n    value: function _end() {\n      this._log.debug('Ended');\n\n      if (this._dummyEl) {\n        this._detachElement(this._dummyEl);\n\n        this._dummyEl.oncanplay = null;\n      }\n    }\n  }, {\n    key: 'attach',\n    value: function attach(el) {\n      var _this2 = this;\n\n      if (typeof el === 'string') {\n        el = this._selectElement(el);\n      } else if (!el) {\n        el = this._createElement();\n      }\n\n      this._log.debug('Attempting to attach to element:', el);\n\n      el = this._attach(el);\n\n      if (this._shouldShimAttachedElements && !this._elShims.has(el)) {\n        var onUnintentionallyPaused = this._playPausedElementsIfNotBackgrounded ? function () {\n          return playIfPausedAndNotBackgrounded(el, _this2._log);\n        } : null;\n\n        this._elShims.set(el, shimMediaElement(el, onUnintentionallyPaused));\n      }\n\n      return el;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_attach',\n    value: function _attach(el) {\n      var mediaStream = el.srcObject;\n\n      if (!(mediaStream instanceof this._MediaStream)) {\n        mediaStream = new this._MediaStream();\n      }\n\n      var getTracks = this.mediaStreamTrack.kind === 'audio' ? 'getAudioTracks' : 'getVideoTracks';\n      mediaStream[getTracks]().forEach(function (mediaStreamTrack) {\n        mediaStream.removeTrack(mediaStreamTrack);\n      });\n      mediaStream.addTrack(this.mediaStreamTrack); // NOTE(mpatwardhan): resetting `srcObject` here, causes flicker (JSDK-2641), but it lets us\n      // to sidestep the a chrome bug: https://bugs.chromium.org/p/chromium/issues/detail?id=1052353\n      //\n\n      el.srcObject = mediaStream;\n      el.autoplay = true;\n      el.playsInline = true;\n\n      if (!this._attachments.has(el)) {\n        this._attachments.add(el);\n      }\n\n      return el;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_selectElement',\n    value: function _selectElement(selector) {\n      var el = document.querySelector(selector);\n\n      if (!el) {\n        throw new Error('Selector matched no element: ' + selector);\n      }\n\n      return el;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_createElement',\n    value: function _createElement() {\n      return typeof document !== 'undefined' ? document.createElement(this.kind) : null;\n    }\n  }, {\n    key: 'detach',\n    value: function detach(el) {\n      var els = void 0;\n\n      if (typeof el === 'string') {\n        els = [this._selectElement(el)];\n      } else if (!el) {\n        els = this._getAllAttachedElements();\n      } else {\n        els = [el];\n      }\n\n      this._log.debug('Attempting to detach from elements:', els);\n\n      this._detachElements(els);\n\n      return el ? els[0] : els;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_detachElements',\n    value: function _detachElements(elements) {\n      return elements.map(this._detachElement.bind(this));\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_detachElement',\n    value: function _detachElement(el) {\n      if (!this._attachments.has(el)) {\n        return el;\n      }\n\n      var mediaStream = el.srcObject;\n\n      if (mediaStream instanceof this._MediaStream) {\n        mediaStream.removeTrack(this.mediaStreamTrack);\n      }\n\n      this._attachments.delete(el);\n\n      if (this._shouldShimAttachedElements && this._elShims.has(el)) {\n        var shim = this._elShims.get(el);\n\n        shim.unShim();\n\n        this._elShims.delete(el);\n      }\n\n      return el;\n    }\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getAllAttachedElements',\n    value: function _getAllAttachedElements() {\n      var els = [];\n\n      this._attachments.forEach(function (el) {\n        els.push(el);\n      });\n\n      return els;\n    }\n  }]);\n\n  return MediaTrack;\n}(Track);\n/**\n * Play an HTMLMediaElement if it is paused and not backgrounded.\n * @private\n * @param {HTMLMediaElement} el\n * @param {Log} log\n * @returns {void}\n */\n\n\nfunction playIfPausedAndNotBackgrounded(el, log) {\n  var tag = el.tagName.toLowerCase();\n  log.warn('Unintentionally paused:', el); // NOTE(mmalavalli): When the element is unintentionally paused, we wait one\n  // second for the \"onvisibilitychange\" event on the HTMLDocument to see if the\n  // app will be backgrounded. If not, then the element can be safely played.\n\n  Promise.race([waitForEvent(document, 'visibilitychange'), waitForSometime(1000)]).then(function () {\n    if (document.visibilityState === 'visible') {\n      // NOTE(mmalavalli): We play the inadvertently paused elements only after\n      // the LocalAudioTrack is unmuted to work around WebKit Bug 213853.\n      //\n      // Bug: https://bugs.webkit.org/show_bug.cgi?id=213853\n      //\n      localMediaRestartDeferreds.whenResolved('audio').then(function () {\n        log.info('Playing unintentionally paused <' + tag + '> element');\n        log.debug('Element:', el);\n        return el.play();\n      }).then(function () {\n        log.info('Successfully played unintentionally paused <' + tag + '> element');\n        log.debug('Element:', el);\n      }).catch(function (error) {\n        log.warn('Error while playing unintentionally paused <' + tag + '> element:', error, el);\n      });\n    }\n  });\n}\n/**\n * Shim the pause() and play() methods of the given HTMLMediaElement so that\n * we can detect if it was paused unintentionally.\n * @param {HTMLMediaElement} el\n * @param {?function} [onUnintentionallyPaused=null]\n * @returns {{pausedIntentionally: function, unShim: function}}\n */\n\n\nfunction shimMediaElement(el) {\n  var onUnintentionallyPaused = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n  var origPause = el.pause;\n  var origPlay = el.play;\n  var _pausedIntentionally = false;\n\n  el.pause = function () {\n    _pausedIntentionally = true;\n    return origPause.call(el);\n  };\n\n  el.play = function () {\n    _pausedIntentionally = false;\n    return origPlay.call(el);\n  };\n\n  var onPause = onUnintentionallyPaused ? function () {\n    if (!_pausedIntentionally) {\n      onUnintentionallyPaused();\n    }\n  } : null;\n\n  if (onPause) {\n    el.addEventListener('pause', onPause);\n  }\n\n  return {\n    pausedIntentionally: function pausedIntentionally() {\n      return _pausedIntentionally;\n    },\n    unShim: function unShim() {\n      el.pause = origPause;\n      el.play = origPlay;\n\n      if (onPause) {\n        el.removeEventListener('pause', onPause);\n      }\n    }\n  };\n}\n\nmodule.exports = MediaTrack;","map":{"version":3,"sources":["/Users/tony_niu/Visual Studio/Twilio/twilio-video-starter-kit/node_modules/twilio-video/es5/media/track/mediatrack.js"],"names":["_typeof","Symbol","iterator","obj","constructor","prototype","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","Constructor","protoProps","staticProps","_classCallCheck","instance","TypeError","_possibleConstructorReturn","self","call","ReferenceError","_inherits","subClass","superClass","create","value","setPrototypeOf","__proto__","_require","require","guessBrowser","_require2","MediaStream","_require3","waitForEvent","waitForSometime","localMediaRestartDeferreds","Track","MediaTrack","_Track","mediaTrackTransceiver","options","assign","playPausedElementsIfNotBackgrounded","document","addEventListener","visibilityState","_this","getPrototypeOf","id","kind","isStarted","_attachments","Set","_dummyEl","_elShims","WeakMap","_isStarted","get","set","_playPausedElementsIfNotBackgrounded","_shouldShimAttachedElements","workaroundWebKitBug212780","_MediaStream","mediaStreamTrack","track","_initialize","_start","_log","debug","oncanplay","emit","_createElement","onended","_end","removeEventListener","muted","bind","_attach","delete","_detachElement","attach","el","_this2","_selectElement","has","onUnintentionallyPaused","playIfPausedAndNotBackgrounded","shimMediaElement","mediaStream","srcObject","getTracks","forEach","removeTrack","addTrack","autoplay","playsInline","add","selector","querySelector","Error","createElement","detach","els","_getAllAttachedElements","_detachElements","elements","map","shim","unShim","push","log","tag","tagName","toLowerCase","warn","Promise","race","then","whenResolved","info","play","catch","error","arguments","undefined","origPause","pause","origPlay","_pausedIntentionally","onPause","pausedIntentionally","module","exports"],"mappings":"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","sourcesContent":["'use strict';\n\nvar _typeof = typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; };\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\"); } return call && (typeof call === \"object\" || typeof call === \"function\") ? call : self; }\n\nfunction _inherits(subClass, superClass) { if (typeof superClass !== \"function\" && superClass !== null) { throw new TypeError(\"Super expression must either be null or a function, not \" + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }\n\nvar _require = require('@twilio/webrtc/lib/util'),\n    guessBrowser = _require.guessBrowser;\n\nvar _require2 = require('@twilio/webrtc'),\n    MediaStream = _require2.MediaStream;\n\nvar _require3 = require('../../util'),\n    waitForEvent = _require3.waitForEvent,\n    waitForSometime = _require3.waitForSometime;\n\nvar localMediaRestartDeferreds = require('../../util/localmediarestartdeferreds');\nvar Track = require('./');\n\n/**\n * A {@link MediaTrack} represents audio or video that can be sent to or\n * received from a {@link Room}.\n * @extends Track\n * @property {Track.ID} id - This {@link Track}'s ID\n * @property {boolean} isStarted - Whether or not the {@link MediaTrack} has\n *   started\n * @property {boolean} isEnabled - Whether or not the {@link MediaTrack} is\n *   enabled (i.e., whether it is paused or muted)\n * @property {Track.Kind} kind - The kind of the underlying\n *   MediaStreamTrack, \"audio\" or \"video\"\n * @property {MediaStreamTrack} mediaStreamTrack - The underlying\n *   MediaStreamTrack\n * @emits MediaTrack#disabled\n * @emits MediaTrack#enabled\n * @emits MediaTrack#started\n */\n\nvar MediaTrack = function (_Track) {\n  _inherits(MediaTrack, _Track);\n\n  /**\n   * Construct a {@link MediaTrack}.\n   * @param {MediaTrackTransceiver} mediaTrackTransceiver\n   * @param {{log: Log}} options\n   */\n  function MediaTrack(mediaTrackTransceiver, options) {\n    _classCallCheck(this, MediaTrack);\n\n    options = Object.assign({\n      playPausedElementsIfNotBackgrounded: guessBrowser() === 'safari' && (typeof document === 'undefined' ? 'undefined' : _typeof(document)) === 'object' && typeof document.addEventListener === 'function' && typeof document.visibilityState === 'string'\n    }, options);\n\n    var _this = _possibleConstructorReturn(this, (MediaTrack.__proto__ || Object.getPrototypeOf(MediaTrack)).call(this, mediaTrackTransceiver.id, mediaTrackTransceiver.kind, options));\n\n    var isStarted = false;\n\n    options = Object.assign({\n      MediaStream: MediaStream\n    }, options);\n\n    /* istanbul ignore next */\n    Object.defineProperties(_this, {\n      _attachments: {\n        value: new Set()\n      },\n      _dummyEl: {\n        value: null,\n        writable: true\n      },\n      _elShims: {\n        value: new WeakMap()\n      },\n      _isStarted: {\n        get: function get() {\n          return isStarted;\n        },\n        set: function set(_isStarted) {\n          isStarted = _isStarted;\n        }\n      },\n      _playPausedElementsIfNotBackgrounded: {\n        value: options.playPausedElementsIfNotBackgrounded\n      },\n      _shouldShimAttachedElements: {\n        value: options.workaroundWebKitBug212780 || options.playPausedElementsIfNotBackgrounded\n      },\n      _MediaStream: {\n        value: options.MediaStream\n      },\n      isStarted: {\n        enumerable: true,\n        get: function get() {\n          return isStarted;\n        }\n      },\n      mediaStreamTrack: {\n        enumerable: true,\n        get: function get() {\n          return mediaTrackTransceiver.track;\n        }\n      }\n    });\n\n    _this._initialize();\n    return _this;\n  }\n\n  /**\n   * @private\n   */\n\n\n  _createClass(MediaTrack, [{\n    key: '_start',\n    value: function _start() {\n      this._log.debug('Started');\n      this._isStarted = true;\n      if (this._dummyEl) {\n        this._dummyEl.oncanplay = null;\n      }\n      // eslint-disable-next-line no-use-before-define\n      this.emit('started', this);\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_initialize',\n    value: function _initialize() {\n      var self = this;\n\n      this._log.debug('Initializing');\n      this._dummyEl = this._createElement();\n\n      this.mediaStreamTrack.addEventListener('ended', function onended() {\n        self._end();\n        self.mediaStreamTrack.removeEventListener('ended', onended);\n      });\n\n      if (this._dummyEl) {\n        this._dummyEl.muted = true;\n        this._dummyEl.oncanplay = this._start.bind(this, this._dummyEl);\n        this._attach(this._dummyEl);\n        this._attachments.delete(this._dummyEl);\n      }\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_end',\n    value: function _end() {\n      this._log.debug('Ended');\n      if (this._dummyEl) {\n        this._detachElement(this._dummyEl);\n        this._dummyEl.oncanplay = null;\n      }\n    }\n  }, {\n    key: 'attach',\n    value: function attach(el) {\n      var _this2 = this;\n\n      if (typeof el === 'string') {\n        el = this._selectElement(el);\n      } else if (!el) {\n        el = this._createElement();\n      }\n      this._log.debug('Attempting to attach to element:', el);\n      el = this._attach(el);\n\n      if (this._shouldShimAttachedElements && !this._elShims.has(el)) {\n        var onUnintentionallyPaused = this._playPausedElementsIfNotBackgrounded ? function () {\n          return playIfPausedAndNotBackgrounded(el, _this2._log);\n        } : null;\n        this._elShims.set(el, shimMediaElement(el, onUnintentionallyPaused));\n      }\n\n      return el;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_attach',\n    value: function _attach(el) {\n      var mediaStream = el.srcObject;\n      if (!(mediaStream instanceof this._MediaStream)) {\n        mediaStream = new this._MediaStream();\n      }\n\n      var getTracks = this.mediaStreamTrack.kind === 'audio' ? 'getAudioTracks' : 'getVideoTracks';\n\n      mediaStream[getTracks]().forEach(function (mediaStreamTrack) {\n        mediaStream.removeTrack(mediaStreamTrack);\n      });\n      mediaStream.addTrack(this.mediaStreamTrack);\n\n      // NOTE(mpatwardhan): resetting `srcObject` here, causes flicker (JSDK-2641), but it lets us\n      // to sidestep the a chrome bug: https://bugs.chromium.org/p/chromium/issues/detail?id=1052353\n      //\n      el.srcObject = mediaStream;\n      el.autoplay = true;\n      el.playsInline = true;\n\n      if (!this._attachments.has(el)) {\n        this._attachments.add(el);\n      }\n\n      return el;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_selectElement',\n    value: function _selectElement(selector) {\n      var el = document.querySelector(selector);\n\n      if (!el) {\n        throw new Error('Selector matched no element: ' + selector);\n      }\n\n      return el;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_createElement',\n    value: function _createElement() {\n      return typeof document !== 'undefined' ? document.createElement(this.kind) : null;\n    }\n  }, {\n    key: 'detach',\n    value: function detach(el) {\n      var els = void 0;\n\n      if (typeof el === 'string') {\n        els = [this._selectElement(el)];\n      } else if (!el) {\n        els = this._getAllAttachedElements();\n      } else {\n        els = [el];\n      }\n\n      this._log.debug('Attempting to detach from elements:', els);\n      this._detachElements(els);\n      return el ? els[0] : els;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_detachElements',\n    value: function _detachElements(elements) {\n      return elements.map(this._detachElement.bind(this));\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_detachElement',\n    value: function _detachElement(el) {\n      if (!this._attachments.has(el)) {\n        return el;\n      }\n\n      var mediaStream = el.srcObject;\n      if (mediaStream instanceof this._MediaStream) {\n        mediaStream.removeTrack(this.mediaStreamTrack);\n      }\n\n      this._attachments.delete(el);\n\n      if (this._shouldShimAttachedElements && this._elShims.has(el)) {\n        var shim = this._elShims.get(el);\n        shim.unShim();\n        this._elShims.delete(el);\n      }\n\n      return el;\n    }\n\n    /**\n     * @private\n     */\n\n  }, {\n    key: '_getAllAttachedElements',\n    value: function _getAllAttachedElements() {\n      var els = [];\n\n      this._attachments.forEach(function (el) {\n        els.push(el);\n      });\n\n      return els;\n    }\n  }]);\n\n  return MediaTrack;\n}(Track);\n\n/**\n * Play an HTMLMediaElement if it is paused and not backgrounded.\n * @private\n * @param {HTMLMediaElement} el\n * @param {Log} log\n * @returns {void}\n */\n\n\nfunction playIfPausedAndNotBackgrounded(el, log) {\n  var tag = el.tagName.toLowerCase();\n  log.warn('Unintentionally paused:', el);\n\n  // NOTE(mmalavalli): When the element is unintentionally paused, we wait one\n  // second for the \"onvisibilitychange\" event on the HTMLDocument to see if the\n  // app will be backgrounded. If not, then the element can be safely played.\n  Promise.race([waitForEvent(document, 'visibilitychange'), waitForSometime(1000)]).then(function () {\n    if (document.visibilityState === 'visible') {\n      // NOTE(mmalavalli): We play the inadvertently paused elements only after\n      // the LocalAudioTrack is unmuted to work around WebKit Bug 213853.\n      //\n      // Bug: https://bugs.webkit.org/show_bug.cgi?id=213853\n      //\n      localMediaRestartDeferreds.whenResolved('audio').then(function () {\n        log.info('Playing unintentionally paused <' + tag + '> element');\n        log.debug('Element:', el);\n        return el.play();\n      }).then(function () {\n        log.info('Successfully played unintentionally paused <' + tag + '> element');\n        log.debug('Element:', el);\n      }).catch(function (error) {\n        log.warn('Error while playing unintentionally paused <' + tag + '> element:', error, el);\n      });\n    }\n  });\n}\n\n/**\n * Shim the pause() and play() methods of the given HTMLMediaElement so that\n * we can detect if it was paused unintentionally.\n * @param {HTMLMediaElement} el\n * @param {?function} [onUnintentionallyPaused=null]\n * @returns {{pausedIntentionally: function, unShim: function}}\n */\nfunction shimMediaElement(el) {\n  var onUnintentionallyPaused = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n\n  var origPause = el.pause;\n  var origPlay = el.play;\n\n  var _pausedIntentionally = false;\n\n  el.pause = function () {\n    _pausedIntentionally = true;\n    return origPause.call(el);\n  };\n\n  el.play = function () {\n    _pausedIntentionally = false;\n    return origPlay.call(el);\n  };\n\n  var onPause = onUnintentionallyPaused ? function () {\n    if (!_pausedIntentionally) {\n      onUnintentionallyPaused();\n    }\n  } : null;\n\n  if (onPause) {\n    el.addEventListener('pause', onPause);\n  }\n\n  return {\n    pausedIntentionally: function pausedIntentionally() {\n      return _pausedIntentionally;\n    },\n    unShim: function unShim() {\n      el.pause = origPause;\n      el.play = origPlay;\n      if (onPause) {\n        el.removeEventListener('pause', onPause);\n      }\n    }\n  };\n}\n\nmodule.exports = MediaTrack;"]},"metadata":{},"sourceType":"script"}